# 使用轻量级的 Node.js 镜像 (Alpine 版本)
# Alpine 体积小，适合做网络工具容器
FROM node:lts-alpine

# 安装基础工具 
# 针对 ArgoSBX/Sing-box/Xray 这类脚本，通常需要 curl, bash, unzip, jq, openssl 等
RUN apk add --no-cache \
    bash \
    curl \
    wget \
    git \
    tzdata \
    ca-certificates \
    openssl \
    tar \
    unzip \
    jq

# 设置工作目录
WORKDIR /app

# 1. 复制所有文件到容器中
# 这是一个"懒人"写法，避免使用 COPY package*.json 时因文件不存在而报错
COPY . .

# 2. 智能依赖安装
# 如果检测到 package.json，才尝试安装 npm 依赖
RUN if [ -f package.json ]; then npm install --production; fi

# 3. 赋予所有可能的脚本执行权限
RUN chmod +x *.sh 2>/dev/null || true
RUN chmod +x *.js 2>/dev/null || true

# 暴露端口 (根据需要修改，Argo/Xray 常用端口可能是 8080 或随机)
# EXPOSE 8080

# 4. 智能启动命令
# 脚本会按顺序检查：
# - 如果有 package.json -> 运行 npm start
# - 如果有 index.js    -> 运行 node index.js
# - 如果有 start.sh    -> 运行 ./start.sh
# - 都没有             -> 报错退出
CMD ["sh", "-c", "if [ -f package.json ]; then npm start; elif [ -f index.js ]; then node index.js; elif [ -f start.sh ]; then ./start.sh; else echo 'Error: No startup script (package.json/index.js/start.sh) found!'; exit 1; fi"]
